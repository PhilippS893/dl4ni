
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Hyperparameter sweeps with Weights&amp;Biases &#8212; DeepLearning for Neuroimaging</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Explainable AI" href="lrp.html" />
    <link rel="prev" title="Classifying MNIST" href="classify_mnist.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">DeepLearning for Neuroimaging</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    An introduction to DeepLearning for Neuroimaging
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../_part1/authors.html">
   Authors
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Prerequisites
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../prereqs/anns.html">
   What are Neural Nets?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="datasets.html">
   PyTorch datasets and dataloaders
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Using the toolbox
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="classify_mnist.html">
   Classifying MNIST
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Hyperparameter sweeps with Weights&amp;Biases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lrp.html">
   Explainable AI
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/PhilippS893/dl4ni/master?urlpath=tree/docs/notebooks/sweep_intro.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/PhilippS893/dl4ni"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/PhilippS893/dl4ni/issues/new?title=Issue%20on%20page%20%2Fnotebooks/sweep_intro.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/notebooks/sweep_intro.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-hyperparameters">
   What are hyperparameters?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-weights-biases-wandb">
   Using weights&amp;biases (wandb)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-sweep-config-with-a-python-dict">
     Setting up a sweep config with a python dict
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-sweep-config-using-a-yaml-file">
     Setting up a sweep config using a yaml file
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-the-sweep">
   Setting up the sweep
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Hyperparameter sweeps with Weights&Biases</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-hyperparameters">
   What are hyperparameters?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-weights-biases-wandb">
   Using weights&amp;biases (wandb)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-sweep-config-with-a-python-dict">
     Setting up a sweep config with a python dict
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-a-sweep-config-using-a-yaml-file">
     Setting up a sweep config using a yaml file
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-the-sweep">
   Setting up the sweep
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="hyperparameter-sweeps-with-weights-biases">
<span id="using-sweeps"></span><h1>Hyperparameter sweeps with Weights&amp;Biases<a class="headerlink" href="#hyperparameter-sweeps-with-weights-biases" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">delphi.utils.train_fns</span> <span class="kn">import</span> <span class="n">standard_train</span>
<span class="kn">from</span> <span class="nn">delphi.networks.LinearNets</span> <span class="kn">import</span> <span class="n">SimpleLinearModel</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span>

<span class="c1"># NEW IMPORTANT IMPORTS</span>
<span class="kn">from</span> <span class="nn">delphi.utils.tools</span> <span class="kn">import</span> <span class="n">compute_accuracy</span><span class="p">,</span> <span class="n">convert_wandb_config</span><span class="p">,</span> <span class="n">read_config</span>
<span class="kn">import</span> <span class="nn">wandb</span>

<span class="c1"># this variable contains information whether a GPU can be used for training. If not, we automatically use the CPU.</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Setting all random seeds for reproducibility.</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the random seed for reproducibility</span>
<span class="k">def</span> <span class="nf">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span> 
    
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span> <span class="c1"># can be used in pytorch dataloaders for reproducible sample selection when shuffle=True</span>
    <span class="n">g</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">g</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">set_random_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us already load the MNIST data such that we do not forget it before running the parameter sweep :).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the MNIST dataset</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="s1">&#39;./data/&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;./data/MNIST&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">())</span>
<span class="n">mnist_test</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="s1">&#39;./data/&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">())</span>

<span class="c1"># create the dataloaders</span>
<span class="n">dl_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">dl_test</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="what-are-hyperparameters">
<h2>What are hyperparameters?<a class="headerlink" href="#what-are-hyperparameters" title="Permalink to this headline">#</a></h2>
<p>A <strong>hyperparameter</strong> is a variable or setting that controls the learning process. Hyperparameters are “known” before the learning process begins and are not changed during training. They should never be confused with the <strong>model parameters</strong> (e.g., weights and biases).</p>
<p>Typical hyperparameters are the following:</p>
<ul class="simple">
<li><p>the learning rate</p></li>
<li><p>the number of hidden layers</p></li>
<li><p>the number of neurons per hidden layer</p></li>
<li><p>the kernel size per convolutional layer</p></li>
<li><p>the number of channels per convolutional layer</p></li>
<li><p>the cost function</p></li>
<li><p>the optimization algorithm</p></li>
<li><p>the activation function</p></li>
<li><p>the number of epochs we use for training</p></li>
<li><p>the batch size</p></li>
<li><p>even the ratio of train/validation splits</p></li>
<li><p>etc.</p></li>
</ul>
<p>I am sure you get the idea that anything that changes the way a network learns is considered a hyperaparameter. Now, depending on how many hyperparameters we use the searchspace of the optimal parameter settings simply explodes. It is thus pretty much impossible to set these parameters manually. Thus we need some help in determining what the optimal parameters in our given searchspace are.</p>
<p>This is where the <span class="xref myst">weights&amp;biases</span> (wandb) package comes into play.</p>
</section>
<section id="using-weights-biases-wandb">
<h2>Using weights&amp;biases (wandb)<a class="headerlink" href="#using-weights-biases-wandb" title="Permalink to this headline">#</a></h2>
<p>What you will see in this jupyterbook is quite condensed and in certain cases you may need additional information that we do not provide here yet. Thus you can check out the official documention of hyperparameter sweeps with wandb <a class="reference external" href="https://docs.wandb.ai/guides/sweeps">here</a>.</p>
<p>How we use wandb (adapted from <a class="reference external" href="https://docs.wandb.ai/guides/sweeps">docs</a>):</p>
<ol class="simple">
<li><p>Write config: Define the variables and ranges to sweep over and determine the search strategy. Wandb offers a few options:</p>
<ul class="simple">
<li><p>grid: run all possible combinations</p></li>
<li><p>random: randomly choose a user supplied <strong>n</strong> number of parameter combinations</p></li>
<li><p>and Bayesian search</p></li>
</ul>
</li>
<li><p>Initialize the search: Wandb hosts a controller and coordinates between the agent(s) that execute the sweep. They can be local or distributed.</p></li>
<li><p>Launch agent(s): If we wanted to use multiple computers, we could use the same command to execute one training process with a selected parameter combination. The agent(s) ask(s) the sweep server what hyperparameter combination to try next, and then they execute the runs.</p></li>
<li><p>We visualize the results: we can do this locally on our computers or we can use the wandb platform to do so.</p></li>
</ol>
<p>Let’s get into it then.</p>
<p>First, we need to set ourselfs a goal. Let’s say we want to use a <code class="docutils literal notranslate"><span class="pre">SimpleLinearModel</span></code> to classify handwritten digits. We saw that the default settings of the <code class="docutils literal notranslate"><span class="pre">SimpleLinearModel</span></code> worked quite well but we cannot be sure that those parameters yield the best results. We therefore decided to do a parameter search over the number of neurons per layer, the learning rate, and the number of epochs.</p>
<p>There are two ways in which we can do it.</p>
<ol class="simple">
<li><p>Defining a python <code class="docutils literal notranslate"><span class="pre">dict</span></code></p></li>
<li><p>Loading a .yaml file</p></li>
</ol>
<p>In the cells below you see how both ways work.</p>
<section id="setting-up-a-sweep-config-with-a-python-dict">
<h3>Setting up a sweep config with a python dict<a class="headerlink" href="#setting-up-a-sweep-config-with-a-python-dict" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sweep_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;linear-mnist-sweep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_acc&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;lin_neurons1&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="c1"># the possible values for the first linear layer</span>
        <span class="p">},</span>
        <span class="s2">&quot;lin_neurons2&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="c1"># the possible values for the second linear layer</span>
        <span class="p">},</span>
        <span class="s2">&quot;lin_neurons3&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="c1"># the possible values for the third linear layer</span>
        <span class="p">},</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># describes the range of possible values for the learning rate</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">.0001</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mf">.1</span>
        <span class="p">},</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="c1"># the possible values for how many epochs to train the network</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-up-a-sweep-config-using-a-yaml-file">
<h3>Setting up a sweep config using a yaml file<a class="headerlink" href="#setting-up-a-sweep-config-using-a-yaml-file" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sweep_config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="s2">&quot;mnist_sweep_config.yaml&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sweep_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;name&#39;: &#39;linear-mnist-sweep&#39;, &#39;method&#39;: &#39;random&#39;, &#39;metric&#39;: {&#39;name&#39;: &#39;test_acc&#39;}, &#39;parameters&#39;: {&#39;lin_neurons1&#39;: {&#39;values&#39;: [512, 256, 128, 64, 32, 16, 8]}, &#39;lin_neurons2&#39;: {&#39;values&#39;: [512, 256, 128, 64, 32, 16, 8]}, &#39;lin_neurons3&#39;: {&#39;values&#39;: [512, 256, 128, 64, 32, 16, 8]}, &#39;learning_rate&#39;: {&#39;min&#39;: 0.0001, &#39;max&#39;: 0.1}, &#39;epochs&#39;: {&#39;values&#39;: [5, 10, 20, 30]}}}
</pre></div>
</div>
</div>
</div>
<p>You probably noticed that this <code class="docutils literal notranslate"><span class="pre">dict</span></code> or config is not in the same format as the <code class="docutils literal notranslate"><span class="pre">dict</span></code> or config we need to configure our neural networks.
Unfortunately, <span class="xref myst">wandb</span> does not yet support nested values in hyperparameter searches (at least not to my knowledge). But do not be alarmed, I took care of this issue for now by writing a converter method called <code class="docutils literal notranslate"><span class="pre">convert_wandb_config</span></code>. You can find it in the <code class="docutils literal notranslate"><span class="pre">_core.utils.tools</span></code> package.</p>
<p>You will see this function in action in the sections below.</p>
</section>
</section>
<section id="setting-up-the-sweep">
<h2>Setting up the sweep<a class="headerlink" href="#setting-up-the-sweep" title="Permalink to this headline">#</a></h2>
<p>We are almost there.</p>
<p>Wandb also requires you to set a function for your agents to call. At least in a jupyternotebook like this one it does.</p>
<p>What you will find in the next code sections are two new functions: <code class="docutils literal notranslate"><span class="pre">train_net()</span></code> and <code class="docutils literal notranslate"><span class="pre">run_train()</span></code></p>
<p>We will now look in detail what each of them does:</p>
<p>In the new <code class="docutils literal notranslate"><span class="pre">train_net()</span></code> function I defined below you should notice, that this function works now for any network you supply to it. Additionally, there is something new in there: the <code class="docutils literal notranslate"><span class="pre">wandb.log()</span></code> function which takes a dict with loss and accuracy scores as arguments. This function is part of the weights&amp;biases package and logs and creates plots from the values we supply to it in real-time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">logwandb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="c1"># loop for the above set number of epochs</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">):</span>

        <span class="c1"># THIS IS WHERE THE MAGIC HAPPENS</span>
        <span class="c1"># calling the model.fit() function will execute the &#39;standard_train&#39; function as defined above.</span>
        <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_stats</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dl_train</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">train_stats</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_stats</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># for validating or testing set the network into evaluation mode such that layers like dropout are not active</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_stats</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dl_test</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">test_acc</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">test_stats</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">test_stats</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch=</span><span class="si">%03d</span><span class="s1">, train_loss=</span><span class="si">%1.3f</span><span class="s1">, train_acc=</span><span class="si">%1.3f</span><span class="s1">, test_loss=</span><span class="si">%1.3f</span><span class="s1">, test_acc=</span><span class="si">%1.3f</span><span class="s1">&#39;</span> <span class="o">%</span> 
             <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">))</span>

        <span class="c1"># LOG PARAMETERS WITH WANDB</span>
        <span class="c1"># Please keep in mind that the code below might be better placed somewhere else</span>
        <span class="c1"># in case you want to use this function without weights and biases or use the</span>
        <span class="c1"># logwandb flag like here</span>
        <span class="k">if</span> <span class="n">logwandb</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
                <span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span>
                <span class="s2">&quot;train_acc&quot;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
                <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="n">test_loss</span><span class="p">,</span>
                <span class="s2">&quot;test_acc&quot;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run_train()</span></code> function defined below might seem a bit redundant. Even though the <code class="docutils literal notranslate"><span class="pre">train_net()</span></code> function implemented above could be adapted with all the code below, it is best to separate as much functionality as much as possible. The way I programmed it now allows me to use the <code class="docutils literal notranslate"><span class="pre">train_net()</span></code> function in many different approaches. Whereas the <code class="docutils literal notranslate"><span class="pre">run_train()</span></code> function is currently specific for the <code class="docutils literal notranslate"><span class="pre">SimpleLinearModel</span></code> class. It is also the function I supply to the sweep-agents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the training function with the wandb init</span>
<span class="k">def</span> <span class="nf">run_train</span><span class="p">():</span>
    
    <span class="c1"># here we initialize weights&amp;biases. </span>
    <span class="k">with</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
        
        <span class="c1">#Within this context we have access to the parameters the agent chose.</span>
        <span class="c1">#It would look something like this:</span>
        <span class="c1">#wandb.config.epochs = 5</span>
        <span class="c1">#wandb.config.lin_neurons1 = 512</span>
        <span class="c1">#wandb.config.lin_neurons2 = 8</span>
        <span class="c1">#wandb.config.lin_neurons3 = 128</span>
        <span class="c1">#wandb.config.learning_rate = 0.00791742</span>
        
        <span class="c1"># here&#39;s the promised conversion of the wandb.config</span>
        <span class="c1"># this results into a dict that contains key-value pairs that we can use to configure our network:</span>
        <span class="c1"># converted_config[&#39;lin_neurons&#39;] = [512, 8, 128]</span>
        <span class="n">converted_config</span> <span class="o">=</span> <span class="n">convert_wandb_config</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">SimpleLinearModel</span><span class="o">.</span><span class="n">_REQUIRED_PARAMS</span><span class="p">)</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">SimpleLinearModel</span><span class="p">(</span><span class="mi">784</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">converted_config</span><span class="p">)</span>
        
        <span class="c1"># We do not necessarily need this line but it is nice to update the config.</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">allow_val_change</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># now train the netwok, yay!</span>
        <span class="n">train_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It is now time to create the sweep and thus the central controller:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">script</span> echo Already ran. Skipping to save time.
# set the wandb sweep config
#os.environ[&#39;WANDB_MODE&#39;] = &#39;offline&#39;
os.environ[&#39;WANDB_ENTITY&#39;] = &quot;philis893&quot; # this is my wandb account name. This can also be a group name, for example
os.environ[&#39;WANDB_PROJECT&#39;] = &quot;test-jupytersweep&quot; # this is simply the project name where we want to store the sweep logs and plots
sweep_id = wandb.sweep(sweep_config)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Already ran. Skipping to save time.
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">script</span> echo Already ran.
count = 20
wandb.agent(sweep_id, function=run_train, count=count)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Already ran.
</pre></div>
</div>
</div>
</div>
<p>Checkout: <a class="reference external" href="https://wandb.ai/philis893/test-jupytersweep/sweeps/ybwt9udl?workspace=user-philis893">https://wandb.ai/philis893/test-jupytersweep/sweeps/ybwt9udl?workspace=user-philis893</a></p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">#</a></h2>
<p>Try running a hyperparameter sweep over different hyperparameters for the <code class="docutils literal notranslate"><span class="pre">Simple2dCnnClassifier</span></code>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="classify_mnist.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Classifying MNIST</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="lrp.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Explainable AI</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Philipp Seidel - Biomedical Imaging Dept. Uni Regensburg<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>